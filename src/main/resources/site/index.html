<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Reign Framework</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le styles -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <style>
      body {
        padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
      }
    </style>
    <link href="css/bootstrap-responsive.min.css" rel="stylesheet">

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="../assets/js/html5shiv.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!--
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
      <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
                    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">
                                   <link rel="shortcut icon" href="../assets/ico/favicon.png">
    -->
  </head>

  <body>

    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="brand" href="#">Reign Framework</a>
          <div class="nav-collapse collapse">
            <ul class="nav" id="nav">              
              <li><a href="#terminal" data-toggle="tab">Terminal</a></li>
              <li><a href="#help" data-toggle="tab">Terminal Guide</a></li>
              <li><a href="#contact" data-toggle="tab">Project Info</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container">

	<div class="tab-content">
		  
	  
	  <div class="tab-pane" id="terminal">
	       <h1 class="text-info">Terminal</h1>
	       Use the terminal to query a Reign node directly.
	       <p>&nbsp;</p>
	       
	       <form onsubmit="return false;">
<div class="controls controls-row">
	<input type="text" id="connectHost" name="connectHost" onkeypress="return checkKey(event);" value="${HOST}" class="span10"/>
	<input class="btn span2" type="button" value="Connect" onclick="connectWebSocket();" />
</div>
       
<div class="controls controls-row">            
<textarea rows="3" type="text" id="sendInput" name="sendInput" onkeypress="return checkKey(event);" placeholder="presence:/[clusterId]/[serviceId]/[nodeId]" class="span10"></textarea>
<input class="btn span2" type="button" value="Send" onclick="send($('#sendInput').val());" />
</div>
           </form>
           
           <hr/>
           <div id="responseText" class="pre-scrollable"></div>
	  </div>
	  
	   
      <div class="tab-pane" id="help">
          <h1 class="text-info">Terminal Guide</h1>
          <hr/>
          
          <h2>General API Format</h2>
          
          <p>Core API calls are REST-ful in style and generally follow the form:<br/>
          <pre>
              [TARGET_SERVICE]:[RESOURCE]?[KEY1]=[VAL2]&amp;[KEY2]=[VAL2]...#[META_COMMAND][OPTIONAL_NEW_LINE]
              [OPTIONAL_MESSAGE_BODY]</pre>
          </p>          
          <p>Even though API calls are over Web Sockets, most calls have been designed in a familiar HTTP REST style.</p>
          <p>&nbsp;</p> 
          <hr/>            

      
          <h2>Presence Service</h2>
          <p>Route API calls to the Presence Service by prefixing with <code>presence:</code></p>
          <h4>List clusters:</h4>
          <code>presence:/</code>    
          <h4>List services in cluster:</h4>
          <code>presence:/[CLUSTER_ID]</code>    
          <h4>List nodes in service:</h4>
          <code>presence:/[CLUSTER_ID]/[SERVICE_ID]</code>   
          <h4>Get info about a service node:</h4>
          <code>presence:/[CLUSTER_ID]/[SERVICE_ID]/[NODE_ID]</code>             
          <hr/>                   
                            
          <h2>Configuration Service</h2>
          <p>Route API calls to the Configuration Service by prefixing with <code>conf:</code></p>
          <p>Serializer to use is based on "file extension" part of path -- required for all configuration paths:<br/>
			".properties" or ".props" = properties serializer</br>
			".js" or ".json" = JSON serializer<br/>
			</p>
			<h4>List available clusters</h4>   
			<code>conf:/</code>
			
			<h4>List configurations in this cluster namespace</h4>
			<code>conf:/[CLUSTER_ID]<br/></code>
			
			<h4>List available configurations or examine configuration contents</h4>
			<code>conf:/[CLUSTER_ID]/[PATH]<br/></code>
			
			<p>If path does not end in an extension, just do a listing.
			If path has extension, return contents using correct serializer.</p>
			
			<h4>Set or replace with new config</h4>
			<code>conf:/[CLUSTER_ID]/[PATH]#put[NEW_LINE]<br/>
			key1=value1[NEW_LINE]<br/>
			key2=value2[NEW_LINE]<br/></code>  
			
			<h4>Update existing or add new configuration</h4>
			<code>conf:/[CLUSTER_ID]/[PATH]#update[NEW_LINE]<br/>  
			key=value[NEW_LINE]<br/>			
			+key=value[NEW_LINE]<br/>
			-key[NEW_LINE]<br/></code>
			
			<p>A "-" means remove this property.<br/>
			A "+" in front of the key means only set this property if it does not already exist.<br/>
			No prefix in front of a key means set this property to the given value.<br/></p>

			
			<h4>Delete config at path</h4>
			<code>conf:/[CLUSTER_ID]/[PATH]#delete</code>  


          <hr/> 
   
          <h2>Coordination Service</h2>
          <p>Route API calls to the Coordination Service by prefixing with <code>coord:</code></p>
          <p>&nbsp;</p>         
          <hr/>  
          
          <h2>Data Service</h2>
          <p>Route API calls to the Coordination Service by prefixing with <code>data:</code></p>
          <p>&nbsp;</p>         
          <hr/> 
          
          <h2>Messaging Service</h2>
          <p>Route API calls to the Messaging Service by prefixing with <code>mesg:</code></p>
		  <h4>Send message to all connected clients and don't wait for response (goes to null service)</h4>
	      <code>mesg:/reign/client#ff<br/>
	      {"body":"Hello World"}<br/>
	      </code>       
          <hr/>         
      
      </div>
	  
	  <div class="tab-pane" id="contact">
	      <h1>Project Info</h1>
	      <p><a href="http://github.com/ypai/reign" target="_new">http://github.com/ypai/reign</a></p>
	  </div>
	</div>

    </div> <!-- /container -->

    <!-- javascript ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/javascript" src="js/jquery-1.10.1.min.js"></script>
    <script type="text/javascript" src="js/bootstrap.min.js"></script>
    <script type="text/javascript" src="js/jquery.gracefulWebSocket.js"></script>

	<script>
	   // show first tab
	   $('#nav li:eq(0) a').tab('show');
	</script>
	
<script type="text/javascript">
var socket; 
var socketOpened = false;

if (!window.WebSocket) {
  window.WebSocket = window.MozWebSocket;
}

function send(message) {
    if (!window.WebSocket) { return; }
    if (!socket || socket.readyState != WebSocket.OPEN) {
        connectWebSocket(); 
        renderRequest('responseText', message);
        // alert("The socket is not open:  reconnecting:  "+$('#connectHost').val()); 
        setTimeout( function(){ if (socket && socket.readyState == WebSocket.OPEN) {socket.send(message);} }, 200);
    } else { 
    	renderRequest('responseText', message);
    	socket.send(message);
    }
} // function

function connectWebSocket() {
	if( socket && socket.readyState!=socket.CLOSED ) return;
	if (window.WebSocket) {
		socket = new WebSocket($('#connectHost').val());
		socket.onmessage = function(event) {    
			renderResponse('responseText', event.data);
		};
		socket.onopen = function(event) { 
			socketOpened = true; 
			renderControlMessage('responseText', 'Web Socket opened:  '+$('#connectHost').val());
			send("presence:/reign/client");
		};
		socket.onclose = function(event) {
		    if( socketOpened ) { 
		    	renderControlMessage('responseText', 'Web Socket closed:&nbsp; '+$('#connectHost').val()); 
		    }     
		    socket = null; 
		    socketOpened = false;
		};  
		socket.onerror = function(event) {
	    	if( socket ) { 
	    		renderControlMessage('responseText', 'Web Socket connection error:&nbsp; '+$('#connectHost').val()); 
	    	}     
	    	socket = null; 
	    	socketOpened = false;
		};
	} else {
	  alert("Your browser does not support Web Socket.");
	}
} // function

var resultCounter=0;

function renderResponse(divElementId, html) {
	var currentValue = resultCounter-1;
    $('#termResultContent'+currentValue).append($('<div>'+html+'</div>').hide().fadeIn('fast'));
    
    // remove earlier items
    var earliestValue = currentValue - 10;
    if( earliestValue>=0 ) {
	    $('#termResult'+earliestValue).fadeOut('slow', 
			function() {
				$('#termResult'+earliestValue).remove();
			}
		);
    }    
}

function renderControlMessage(divElementId, html) {
    var currentValue = resultCounter++;
    $('#'+divElementId).prepend($('<div id="termResult'+currentValue+'"><div><pre id="termResultContent'+currentValue+'"><div class="text-warning">&gt;&nbsp;'+html+'</div></pre></div></div>').hide().fadeIn('fast'));

}

function renderRequest(divElementId, html) { 
    //var theDiv = document.getElementById(divElementId);
    //var contentDiv = document.createElement('div');
    //var content = document.createElement('pre'); content.innerHTML = html;
    //contentDiv.appendChild(content);
    //theDiv.appendChild(contentDiv); 
    var currentValue = resultCounter++;
    $('#'+divElementId).prepend($('<div id="termResult'+currentValue+'"><div><pre id="termResultContent'+currentValue+'"><div class="text-success">'+html+'</div></pre></div></div>').hide().fadeIn('fast'));
//    $('#'+divElementId).prepend($('<div id="termResult'+currentValue+'"><div><pre>'+html+'<button id="termResultClose'+currentValue+'" class="close">&times;</button></pre></div></div>').hide().fadeIn('fast'));
//     $('#termResultClose'+currentValue).on("click", 
//     	function(event) { 
//     		$('#termResult'+currentValue).fadeOut('fast', 
//     			function() {
//     				$('#termResult'+currentValue).remove();
//     			}
//     		); 
//     	}
//     );
    

    //theDiv.scrollTop = theDiv.scrollHeight; 
} // function

function checkKey(e) { 
	if( e && e.keyCode==13 && $('#sendInput').val().match("^presence:")) { 
		send($('#sendInput').val()); 
		return false; 
	} 
}

connectWebSocket();
</script>


  </body>
</html>

